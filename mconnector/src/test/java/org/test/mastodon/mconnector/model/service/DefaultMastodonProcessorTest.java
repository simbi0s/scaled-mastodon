package org.test.mastodon.mconnector.model.service;

import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.Test;
import org.mastodon4j.core.api.entities.Event;
import org.mockito.ArgumentCaptor;
import org.mockito.ArgumentMatchers;
import org.mockito.Mockito;
import org.springframework.amqp.rabbit.core.RabbitOperations;

import java.util.Collections;

class DefaultMastodonProcessorTest {

	// Given-When-Then syntax
	@Test
	void validPayload_process_correctlyProcessed() {

		RabbitOperations rabbitmq = Mockito.mock(RabbitOperations.class);

		DefaultMastodonProcessor processor = new DefaultMastodonProcessor(rabbitmq);

		String eventPayload = "{\n" + "  \"id\": \"113010739617830268\",\n" + "  \"created_at\": \"2024-08-23T09:57:16.000Z\",\n" + "  \"in_reply_to_id\": null,\n" + "  \"in_reply_to_account_id\": null,\n" + "  \"sensitive\": false,\n" + "  \"spoiler_text\": \"\",\n" + "  \"visibility\": \"public\",\n" + "  \"language\": \"it\",\n" + "  \"uri\": \"https://mastodon.uno/users/formula1it/statuses/113010739543644296\",\n" + "  \"url\": \"https://mastodon.uno/@formula1it/113010739543644296\",\n" + "  \"replies_count\": 0,\n" + "  \"reblogs_count\": 0,\n" + "  \"favourites_count\": 0,\n" + "  \"edited_at\": null,\n" + "  \"content\": \"<p><a href=\\\"https://mastodon.uno/tags/LIVE\\\" class=\\\"mention hashtag\\\" rel=\\\"nofollow noopener noreferrer\\\" target=\\\"_blank\\\">#<span>LIVE</span></a> - Prove Libere 1 GP Olanda 2024 <a href=\\\"https://www.formula1.it/news/21239/1/live-prove-libere-1-gp-olanda-2024?utm_source=dlvr.it&amp;utm_medium=mastodon\\\" rel=\\\"nofollow noopener noreferrer\\\" translate=\\\"no\\\" target=\\\"_blank\\\"><span class=\\\"invisible\\\">https://www.</span><span class=\\\"ellipsis\\\">formula1.it/news/21239/1/live-</span><span class=\\\"invisible\\\">prove-libere-1-gp-olanda-2024?utm_source=dlvr.it&amp;utm_medium=mastodon</span></a></p>\",\n" + "  \"reblog\": null,\n" + "  \"account\": {\n" + "    \"id\": \"109669504927311608\",\n" + "    \"username\": \"formula1it\",\n" + "    \"acct\": \"formula1it@mastodon.uno\",\n" + "    \"display_name\": \"Formula1.it :verified:\",\n" + "    \"locked\": false,\n" + "    \"bot\": false,\n" + "    \"discoverable\": true,\n" + "    \"indexable\": false,\n" + "    \"group\": false,\n" + "    \"created_at\": \"2023-01-10T00:00:00.000Z\",\n" + "    \"note\": \"<p>Il sito italiano dedicato al circus iridato. Classifiche, news, rubriche, articoli, gran premi, scuderie, circuiti e sondaggi</p>\",\n" + "    \"url\": \"https://mastodon.uno/@formula1it\",\n" + "    \"uri\": \"https://mastodon.uno/users/formula1it\",\n" + "    \"avatar\": \"https://files.mastodon.social/cache/accounts/avatars/109/669/504/927/311/608/original/7327a97481560911.png\",\n" + "    \"avatar_static\": \"https://files.mastodon.social/cache/accounts/avatars/109/669/504/927/311/608/original/7327a97481560911.png\",\n" + "    \"header\": \"https://files.mastodon.social/cache/accounts/headers/109/669/504/927/311/608/original/c3a444b79774808a.jpg\",\n" + "    \"header_static\": \"https://files.mastodon.social/cache/accounts/headers/109/669/504/927/311/608/original/c3a444b79774808a.jpg\",\n" + "    \"followers_count\": 428,\n" + "    \"following_count\": 1,\n" + "    \"statuses_count\": 8550,\n" + "    \"last_status_at\": \"2024-08-23\",\n" + "    \"hide_collections\": false,\n" + "    \"emojis\": [\n" + "      {\n" + "        \"shortcode\": \"verified\",\n" + "        \"url\": \"https://files.mastodon.social/cache/custom_emojis/images/000/208/294/original/5186930680dd9275.png\",\n" + "        \"static_url\": \"https://files.mastodon.social/cache/custom_emojis/images/000/208/294/static/5186930680dd9275.png\",\n" + "        \"visible_in_picker\": true\n" + "      }\n" + "    ],\n" + "    \"fields\": [\n" + "      {\n" + "        \"name\": \"Sito\",\n" + "        \"value\": \"<a href=\\\"https://www.formula1.it/\\\" rel=\\\"nofollow noopener noreferrer\\\" translate=\\\"no\\\" target=\\\"_blank\\\"><span class=\\\"invisible\\\">https://www.</span><span class=\\\"\\\">formula1.it/</span><span class=\\\"invisible\\\"></span></a>\",\n" + "        \"verified_at\": null\n" + "      },\n" + "      {\n" + "        \"name\": \"Twitter\",\n" + "        \"value\": \"<a href=\\\"https://twitter.com/Formula1WM\\\" rel=\\\"nofollow noopener noreferrer\\\" translate=\\\"no\\\" target=\\\"_blank\\\"><span class=\\\"invisible\\\">https://</span><span class=\\\"\\\">twitter.com/Formula1WM</span><span class=\\\"invisible\\\"></span></a>\",\n" + "        \"verified_at\": null\n" + "      },\n" + "      {\n" + "        \"name\": \"Facebook\",\n" + "        \"value\": \"<a href=\\\"https://www.facebook.com/Formula1it\\\" rel=\\\"nofollow noopener noreferrer\\\" translate=\\\"no\\\" target=\\\"_blank\\\"><span class=\\\"invisible\\\">https://www.</span><span class=\\\"\\\">facebook.com/Formula1it</span><span class=\\\"invisible\\\"></span></a>\",\n" + "        \"verified_at\": null\n" + "      },\n" + "      {\n" + "        \"name\": \"Classifiche\",\n" + "        \"value\": \"<a href=\\\"https://www.formula1.it/classifiche\\\" rel=\\\"nofollow noopener noreferrer\\\" translate=\\\"no\\\" target=\\\"_blank\\\"><span class=\\\"invisible\\\">https://www.</span><span class=\\\"\\\">formula1.it/classifiche</span><span class=\\\"invisible\\\"></span></a>\",\n" + "        \"verified_at\": null\n" + "      }\n" + "    ]\n" + "  },\n" + "  \"media_attachments\": [\n" + "    {\n" + "      \"id\": \"113010739580441863\",\n" + "      \"type\": \"image\",\n" + "      \"url\": \"https://files.mastodon.social/cache/media_attachments/files/113/010/739/580/441/863/original/2f810f7556c8eb90.jpeg\",\n" + "      \"preview_url\": \"https://files.mastodon.social/cache/media_attachments/files/113/010/739/580/441/863/small/2f810f7556c8eb90.jpeg\",\n" + "      \"remote_url\": \"https://cdn.masto.host/mastodonuno/media_attachments/files/113/010/739/436/910/949/original/353941ad6c8ef6e1.jpeg\",\n" + "      \"preview_remote_url\": null,\n" + "      \"text_url\": null,\n" + "      \"meta\": {\n" + "        \"original\": {\n" + "          \"width\": 772,\n" + "          \"height\": 469,\n" + "          \"size\": \"772x469\",\n" + "          \"aspect\": 1.6460554371002132\n" + "        },\n" + "        \"small\": {\n" + "          \"width\": 616,\n" + "          \"height\": 374,\n" + "          \"size\": \"616x374\",\n" + "          \"aspect\": 1.6470588235294117\n" + "        }\n" + "      },\n" + "      \"description\": null,\n" + "      \"blurhash\": \"USD@{#WW0yS257jZ-VoLx]oLM{jZMxWp%2bH\"\n" + "    }\n" + "  ],\n" + "  \"mentions\": [],\n" + "  \"tags\": [\n" + "    {\n" + "      \"name\": \"live\",\n" + "      \"url\": \"https://mastodon.social/tags/live\"\n" + "    }\n" + "  ],\n" + "  \"emojis\": [],\n" + "  \"card\": null,\n" + "  \"poll\": null,\n" + "  \"filtered\": []\n" + "}";
		var event = new Event(Collections.emptyList(), "update", eventPayload);
		processor.process(event);

		ArgumentCaptor<String> streamNameCaptor = ArgumentCaptor.forClass(String.class);
		ArgumentCaptor<String> streamValueCaptor = ArgumentCaptor.forClass(String.class);
		Mockito.verify(rabbitmq).convertAndSend(streamNameCaptor.capture(), streamValueCaptor.capture());

		var streamName = streamNameCaptor.getValue();
		var streamValue = streamValueCaptor.getValue();

		Assertions.assertEquals("posts-stream-n1", streamName);
		Assertions.assertEquals(
				"{\"id\":\"113010739617830268\",\"content\":\"<p><a href=\\\"https://mastodon.uno/tags/LIVE\\\" class=\\\"mention hashtag\\\" rel=\\\"nofollow noopener noreferrer\\\" target=\\\"_blank\\\">#<span>LIVE</span></a> - Prove Libere 1 GP Olanda 2024 <a href=\\\"https://www.formula1.it/news/21239/1/live-prove-libere-1-gp-olanda-2024?utm_source=dlvr.it&amp;utm_medium=mastodon\\\" rel=\\\"nofollow noopener noreferrer\\\" translate=\\\"no\\\" target=\\\"_blank\\\"><span class=\\\"invisible\\\">https://www.</span><span class=\\\"ellipsis\\\">formula1.it/news/21239/1/live-</span><span class=\\\"invisible\\\">prove-libere-1-gp-olanda-2024?utm_source=dlvr.it&amp;utm_medium=mastodon</span></a></p>\",\"account\":{\"username\":\"formula1it\"},\"created_at\":\"2024-08-23T09:57:16.000Z\"}",
				streamValue
		);
	}

	@Test
	void invalidPayload_process_skipped() {

		RabbitOperations rabbitmq = Mockito.mock(RabbitOperations.class);

		DefaultMastodonProcessor processor = new DefaultMastodonProcessor(rabbitmq);

		String eventPayload = "invalid json";
		var event = new Event(Collections.emptyList(), "update", eventPayload);
		processor.process(event);

		Mockito.verify(rabbitmq, Mockito.never()).convertAndSend(ArgumentMatchers.anyString(), ArgumentMatchers.anyString());
	}

	@Test
	void deleteEventPayload_process_skipped() {

		RabbitOperations rabbitmq = Mockito.mock(RabbitOperations.class);

		DefaultMastodonProcessor processor = new DefaultMastodonProcessor(rabbitmq);

		String eventPayload = "{\n" + "  \"id\": \"113010739617830268\",\n" + "  \"created_at\": \"2024-08-23T09:57:16.000Z\",\n" + "  \"in_reply_to_id\": null,\n" + "  \"in_reply_to_account_id\": null,\n" + "  \"sensitive\": false,\n" + "  \"spoiler_text\": \"\",\n" + "  \"visibility\": \"public\",\n" + "  \"language\": \"it\",\n" + "  \"uri\": \"https://mastodon.uno/users/formula1it/statuses/113010739543644296\",\n" + "  \"url\": \"https://mastodon.uno/@formula1it/113010739543644296\",\n" + "  \"replies_count\": 0,\n" + "  \"reblogs_count\": 0,\n" + "  \"favourites_count\": 0,\n" + "  \"edited_at\": null,\n" + "  \"content\": \"<p><a href=\\\"https://mastodon.uno/tags/LIVE\\\" class=\\\"mention hashtag\\\" rel=\\\"nofollow noopener noreferrer\\\" target=\\\"_blank\\\">#<span>LIVE</span></a> - Prove Libere 1 GP Olanda 2024 <a href=\\\"https://www.formula1.it/news/21239/1/live-prove-libere-1-gp-olanda-2024?utm_source=dlvr.it&amp;utm_medium=mastodon\\\" rel=\\\"nofollow noopener noreferrer\\\" translate=\\\"no\\\" target=\\\"_blank\\\"><span class=\\\"invisible\\\">https://www.</span><span class=\\\"ellipsis\\\">formula1.it/news/21239/1/live-</span><span class=\\\"invisible\\\">prove-libere-1-gp-olanda-2024?utm_source=dlvr.it&amp;utm_medium=mastodon</span></a></p>\",\n" + "  \"reblog\": null,\n" + "  \"account\": {\n" + "    \"id\": \"109669504927311608\",\n" + "    \"username\": \"formula1it\",\n" + "    \"acct\": \"formula1it@mastodon.uno\",\n" + "    \"display_name\": \"Formula1.it :verified:\",\n" + "    \"locked\": false,\n" + "    \"bot\": false,\n" + "    \"discoverable\": true,\n" + "    \"indexable\": false,\n" + "    \"group\": false,\n" + "    \"created_at\": \"2023-01-10T00:00:00.000Z\",\n" + "    \"note\": \"<p>Il sito italiano dedicato al circus iridato. Classifiche, news, rubriche, articoli, gran premi, scuderie, circuiti e sondaggi</p>\",\n" + "    \"url\": \"https://mastodon.uno/@formula1it\",\n" + "    \"uri\": \"https://mastodon.uno/users/formula1it\",\n" + "    \"avatar\": \"https://files.mastodon.social/cache/accounts/avatars/109/669/504/927/311/608/original/7327a97481560911.png\",\n" + "    \"avatar_static\": \"https://files.mastodon.social/cache/accounts/avatars/109/669/504/927/311/608/original/7327a97481560911.png\",\n" + "    \"header\": \"https://files.mastodon.social/cache/accounts/headers/109/669/504/927/311/608/original/c3a444b79774808a.jpg\",\n" + "    \"header_static\": \"https://files.mastodon.social/cache/accounts/headers/109/669/504/927/311/608/original/c3a444b79774808a.jpg\",\n" + "    \"followers_count\": 428,\n" + "    \"following_count\": 1,\n" + "    \"statuses_count\": 8550,\n" + "    \"last_status_at\": \"2024-08-23\",\n" + "    \"hide_collections\": false,\n" + "    \"emojis\": [\n" + "      {\n" + "        \"shortcode\": \"verified\",\n" + "        \"url\": \"https://files.mastodon.social/cache/custom_emojis/images/000/208/294/original/5186930680dd9275.png\",\n" + "        \"static_url\": \"https://files.mastodon.social/cache/custom_emojis/images/000/208/294/static/5186930680dd9275.png\",\n" + "        \"visible_in_picker\": true\n" + "      }\n" + "    ],\n" + "    \"fields\": [\n" + "      {\n" + "        \"name\": \"Sito\",\n" + "        \"value\": \"<a href=\\\"https://www.formula1.it/\\\" rel=\\\"nofollow noopener noreferrer\\\" translate=\\\"no\\\" target=\\\"_blank\\\"><span class=\\\"invisible\\\">https://www.</span><span class=\\\"\\\">formula1.it/</span><span class=\\\"invisible\\\"></span></a>\",\n" + "        \"verified_at\": null\n" + "      },\n" + "      {\n" + "        \"name\": \"Twitter\",\n" + "        \"value\": \"<a href=\\\"https://twitter.com/Formula1WM\\\" rel=\\\"nofollow noopener noreferrer\\\" translate=\\\"no\\\" target=\\\"_blank\\\"><span class=\\\"invisible\\\">https://</span><span class=\\\"\\\">twitter.com/Formula1WM</span><span class=\\\"invisible\\\"></span></a>\",\n" + "        \"verified_at\": null\n" + "      },\n" + "      {\n" + "        \"name\": \"Facebook\",\n" + "        \"value\": \"<a href=\\\"https://www.facebook.com/Formula1it\\\" rel=\\\"nofollow noopener noreferrer\\\" translate=\\\"no\\\" target=\\\"_blank\\\"><span class=\\\"invisible\\\">https://www.</span><span class=\\\"\\\">facebook.com/Formula1it</span><span class=\\\"invisible\\\"></span></a>\",\n" + "        \"verified_at\": null\n" + "      },\n" + "      {\n" + "        \"name\": \"Classifiche\",\n" + "        \"value\": \"<a href=\\\"https://www.formula1.it/classifiche\\\" rel=\\\"nofollow noopener noreferrer\\\" translate=\\\"no\\\" target=\\\"_blank\\\"><span class=\\\"invisible\\\">https://www.</span><span class=\\\"\\\">formula1.it/classifiche</span><span class=\\\"invisible\\\"></span></a>\",\n" + "        \"verified_at\": null\n" + "      }\n" + "    ]\n" + "  },\n" + "  \"media_attachments\": [\n" + "    {\n" + "      \"id\": \"113010739580441863\",\n" + "      \"type\": \"image\",\n" + "      \"url\": \"https://files.mastodon.social/cache/media_attachments/files/113/010/739/580/441/863/original/2f810f7556c8eb90.jpeg\",\n" + "      \"preview_url\": \"https://files.mastodon.social/cache/media_attachments/files/113/010/739/580/441/863/small/2f810f7556c8eb90.jpeg\",\n" + "      \"remote_url\": \"https://cdn.masto.host/mastodonuno/media_attachments/files/113/010/739/436/910/949/original/353941ad6c8ef6e1.jpeg\",\n" + "      \"preview_remote_url\": null,\n" + "      \"text_url\": null,\n" + "      \"meta\": {\n" + "        \"original\": {\n" + "          \"width\": 772,\n" + "          \"height\": 469,\n" + "          \"size\": \"772x469\",\n" + "          \"aspect\": 1.6460554371002132\n" + "        },\n" + "        \"small\": {\n" + "          \"width\": 616,\n" + "          \"height\": 374,\n" + "          \"size\": \"616x374\",\n" + "          \"aspect\": 1.6470588235294117\n" + "        }\n" + "      },\n" + "      \"description\": null,\n" + "      \"blurhash\": \"USD@{#WW0yS257jZ-VoLx]oLM{jZMxWp%2bH\"\n" + "    }\n" + "  ],\n" + "  \"mentions\": [],\n" + "  \"tags\": [\n" + "    {\n" + "      \"name\": \"live\",\n" + "      \"url\": \"https://mastodon.social/tags/live\"\n" + "    }\n" + "  ],\n" + "  \"emojis\": [],\n" + "  \"card\": null,\n" + "  \"poll\": null,\n" + "  \"filtered\": []\n" + "}";
		var event = new Event(Collections.emptyList(), "delete", eventPayload);
		processor.process(event);

		Mockito.verify(rabbitmq, Mockito.never()).convertAndSend(ArgumentMatchers.anyString(), ArgumentMatchers.anyString());
	}

}